# 第五章

## 5. 延迟依赖查找



![image-20210601222301659](C:\Users\KeHe\AppData\Roaming\Typora\typora-user-images\image-20210601222301659.png)

### 5.1 函数式接口

代码位置dependency.lookup.ObjectProviderDemo

主程序

```java
// 创建 BeanFactory 容器
        AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
        // 将当前类 ObjectProviderDemo 作为配置类（Configuration Class）
        applicationContext.register(ObjectProviderDemo.class);
        // 启动应用上下文
        applicationContext.refresh();

        // 依赖查找集合对象
        lookupByObjectProvider(applicationContext);

        lookupIfAvailable(applicationContext);

        // 关闭应用上下文
        applicationContext.close();
```

其中的lookupIfAvailable方法

```java
private static void lookupIfAvailable(AnnotationConfigApplicationContext applicationContext) {
        ObjectProvider<User> userObjectProvider = applicationContext.getBeanProvider(User.class);
        //User user = userObjectProvider.getIfAvailable(() -> User.createUser());
        User user = userObjectProvider.getIfAvailable(User::createUser);
        System.out.println("当前 User 对象：" + user);
    }
```

注意点1：

​	getBeanProvider方法

注意点2：

​	getIfAvailable方法是一个函数式接口

注意点3：

​	public interface ObjectProvider<T> extends ObjectFactory<T>, Iterable<T>

​	ObjectProvider继承自ObjectFactory



### 5.2 Stream扩展

代码位置dependency.lookup.ObjectProviderDemo中的lookupByStreamOps方法

主程序：

```java
// 创建 BeanFactory 容器
        AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
        // 将当前类 ObjectProviderDemo 作为配置类（Configuration Class）
        applicationContext.register(ObjectProviderDemo.class);
        // 启动应用上下文
        applicationContext.refresh();

        // 依赖查找集合对象
        lookupByObjectProvider(applicationContext);

        lookupIfAvailable(applicationContext);

        lookupByStreamOps(applicationContext);

        // 关闭应用上下文
        applicationContext.close();
```

lookupByStreamOps方法：

```java
private static void lookupByStreamOps(AnnotationConfigApplicationContext applicationContext) {
        ObjectProvider<String> objectProvider = applicationContext.getBeanProvider(String.class);
        /*Iterable<String> stringIterable = objectProvider;
        for (String string : stringIterable) {
           System.out.println(string);
        }*/

        objectProvider.stream().forEach(System.out::println);
    }
```

其中需要两个bean，一个需要@Primary注解

```java
	@Bean
    @Primary
    public String helloWorld() {
        return "hello,World";
    }

    @Bean
    public String message() {
        return "Message";
    }
```

得到结果：

hello,World
Message

注意1：

​	查找所有的String类型的bean

注意2：

​	ObjectProvider是由迭代器功能



## 6. 安全依赖查找  

![image-20210601230919512](C:\Users\KeHe\AppData\Roaming\Typora\typora-user-images\image-20210601230919512.png)

org.geekbang.thinking.in.spring.dependency.lookup.TypeSafetyDependencyLookupDemo代码

### 6.1 单一类型查找

**演示 BeanFactory#getBean 方法的安全性**

***如果一个bean的类型有多种，比如有两个以上的实例，通过这个方法会报错***

```java
public static void main(String[] args) {
        // 创建 BeanFactory 容器
        AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
        // 将当前类 TypeSafetyDependencyLookupDemo 作为配置类（Configuration Class）
        applicationContext.register(TypeSafetyDependencyLookupDemo.class);
        // 启动应用上下文
        applicationContext.refresh();

        // 演示 BeanFactory#getBean 方法的安全性
        displayBeanFactoryGetBean(applicationContext);


        // 关闭应用上下文
        applicationContext.close();
    }

    private static void displayBeanFactoryGetBean(BeanFactory beanFactory) {
        printBeansException("displayBeanFactoryGetBean", () -> beanFactory.getBean(User.class));

    }


    private static void printBeansException(String source, Runnable runnable) {
        System.err.println("==========================================");
        System.err.println("Source from :" + source);
        try {
            runnable.run();
        } catch (BeansException exception) {
            exception.printStackTrace();
        }
    }
```

此时报错：

​	org.springframework.beans.factory.NoSuchBeanDefinitionException: 

在getBean方法的注释上面列举了异常的类型

```java
@throws NoSuchBeanDefinitionException if no bean of the given type was found
@throws NoUniqueBeanDefinitionException if more than one bean of the given type was found
@throws BeansException if the bean could not be created
```



**演示 ObjectFactory#getObject 方法的安全性**
main中添加方法

```java
// 演示 ObjectFactory#getObject 方法的安全性
displayObjectFactoryGetObject(applicationContext);
```

```java
private static void displayObjectFactoryGetObject(AnnotationConfigApplicationContext applicationContext) {
    // ObjectProvider is ObjectFactory
    ObjectFactory<User> userObjectFactory = applicationContext.getBeanProvider(User.class);
    printBeansException("displayObjectFactoryGetObject", () -> userObjectFactory.getObject());

}
```

注意：

​	ObjectProvider is ObjectFactory



 **演示 ObjectProvider#getIfAvaiable 方法的安全性**

主程序中添加

```java
// 演示 ObjectProvider#getIfAvaiable 方法的安全性
displayObjectProviderIfAvailable(applicationContext);
```

方法

```java
private static void displayObjectProviderIfAvailable(AnnotationConfigApplicationContext applicationContext) {
    ObjectProvider<User> userObjectProvider = applicationContext.getBeanProvider(User.class);
    printBeansException("displayObjectProviderIfAvailable", () -> userObjectProvider.getIfAvailable());
}
```

结果是安全的



### 6.2 集合类型查找

**演示 ListableBeanFactory#getBeansOfType 方法的安全性**

主程序中：

```java
// 演示 ListableBeanFactory#getBeansOfType 方法的安全性
displayListableBeanFactoryGetBeansOfType(applicationContext);
```

方法：

```java
private static void displayListableBeanFactoryGetBeansOfType(ListableBeanFactory beanFactory) {
    printBeansException("displayListableBeanFactoryGetBeansOfType", () -> beanFactory.getBeansOfType(User.class));
}
```



**演示 ObjectProvider Stream 操作的安全性**

主程序中

```java
displayObjectProviderStreamOps(applicationContext);
```

方法

```java
private static void displayObjectProviderStreamOps(AnnotationConfigApplicationContext applicationContext) {
    ObjectProvider<User> userObjectProvider = applicationContext.getBeanProvider(User.class);
    printBeansException("displayObjectProviderStreamOps", () -> userObjectProvider.forEach(System.out::println));
}
```
