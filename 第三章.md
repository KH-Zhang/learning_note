# 第三章  Spring AOP API 设计与实现  

## 3.1 Spring AOP API 整体设计  

• Join point - Joinpoint
• Pointcut - Pointcut
• Advice 执行动作 - Advice
• Advice 容器 - Advisor
• Introduction - IntroductionInfo
• 代理对象创建基础类 - ProxyCreatorSupport
• 代理工厂 - ProxyFactory、 ProxyFactoryBean
• AopProxyFactory 配置管理器 - AdvisedSupport
• IoC 容器自动代理抽象 - AbstractAutoProxyCreator  





## 3.2 接入点接口 - Joinpoint  

• Interceptor 执行上下文 - Invocation
		• 方法拦截器执行上下文 - MethodInvocation
		~~• 构造器拦截器执行上下文 - ConstructorInvocation~~
• MethodInvocation 实现
		• 基于反射 - ReflectiveMethodInvocation
		• 基于 CGLIB - CglibMethodInvocation  

（1）

```java
ProxyMethodInvocation extends MethodInvocation
```

（2）

ReflectiveMethodInvocation和CglibMethodInvocation都是实现了ProxyMethodInvocation接口。





## 3.3 Joinpoint 条件接口 - Pointcut  

核心组件
		• 类过滤器 - ClassFilter
		• 方法匹配器 - MethodMatcher  



主程序：EchoServiceEchoMethodPointcut，PointcutAPIDemo



工具类
• ClassFilter 工具类 - ClassFilters
• MethodMatcher 工具类 - MethodMatchers
• Pointcut 工具类 - Pointcuts 

 



## 3.4 Pointcut 便利实现  

• 静态 Pointcut - StaticMethodMatcherPointcut
• 正则表达式 Pointcut - JdkRegexpMethodPointcut
• 控制流 Pointcut - ControlFlowPointcut  



主程序：PointcutAPIDemo

```java
ComposablePointcut pointcut = new ComposablePointcut(EchoServiceEchoMethodPointcut.INSTANCE);
// 组合实现
pointcut.intersection(echoServicePointcut.getClassFilter());
pointcut.intersection(echoServicePointcut.getMethodMatcher());
```





## 3.5 Pointcut AspectJ 实现  

• 实现类 - org.springframework.aop.aspectj.AspectJExpressionPointcut
• 指令支持 - SUPPORTED_PRIMITIVES 字段
• 表达式 - org.aspectj.weaver.tools.PointcutExpression  



Spring利用AspectJ的表达式来桥接

（1）AspectJExpressionPointcut中的pointcutExpression

（2）AspectJExpressionPointcut中的obtainPointcutExpression()方法





## 3.6 Joinpoint 执行动作接口 - Advice  

• **Around Advice** - **Interceptor**
		• 方法拦截器 - **MethodInterceptor**
		• 构造器拦截器 - ConstructorInterceptor
• **前置动作**
		• 标准接口 - org.springframework.aop.BeforeAdvice
		• 方法级别 - org.springframework.aop.MethodBeforeAdvice
• **后置动作**
		• org.springframework.aop.AfterAdvice
		• org.springframework.aop.AfterReturningAdvice
		• org.springframework.aop.ThrowsAdvice  



注意：Advice分为三种，BeforeAdvice,AfterAdvice和Interceptor





## 3.7 Joinpoint Before Advice 标准实现  

• 接口
		• 标准接口 - org.springframework.aop.BeforeAdvice
		• 方法级别 - org.springframework.aop.MethodBeforeAdvice
• 实现
		• org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor  



## 3.8 Joinpoint Before Advice AspectJ 实现  (难度大)

实现类 - org.springframework.aop.aspectj.AspectJMethodBeforeAdvice  



## 3.9 Joinpoint After Advice 标准实现  

**接口**
• org.springframework.aop.AfterAdvice
• org.springframework.aop.AfterReturningAdvice
• org.springframework.aop.ThrowsAdvice
**实现**
• org.springframework.aop.framework.adapter.ThrowsAdviceInterceptor
• org.springframework.aop.framework.adapter.AfterReturningAdviceInterceptor  



1. AfterReturningAdviceInterceptor  

- 三个接口之间的关系

- AfterReturningAdviceInterceptor  

  每个advice都会包装成Interceptor 

- 查看主程序AspectJAnnotationUsingAPIDemo



理解：

AfterReturningAdviceInterceptor中的invoke方法执行的时候：

先调用具体的实现方法Object retVal = mi.proceed();

再调用afterReturning拦截方法。



2.ThrowsAdviceInterceptor

- 从构造函数public ThrowsAdviceInterceptor(Object throwsAdvice)中可以看出方法参数必须是一个或者4个。
- ThrowsAdviceDemo





## 3.10 Joinpoint After Advice AspectJ 实现  

**接口**
• org.springframework.aop.AfterAdvice
• org.springframework.aop.AfterReturningAdvice
• org.springframework.aop.ThrowsAdvice
**实现**
• org.springframework.aop.aspectj.AspectJAfterAdvice
• org.springframework.aop.aspectj.AspectJAfterReturningAdvice
• org.springframework.aop.aspectj.AspectJAfterThrowingAdvice  



- 首先AspectJAfterAdvice，继承了AbstractAspectJAdvice

```java
@AfterReturning("anyPublicMethod()")
// AspectJAfterReturningAdvice is AfterReturningAdvice
// 一个 AfterReturningAdviceInterceptor 关联一个 AfterReturningAdvice
// Spring 封装 AfterReturningAdvice -> AfterReturningAdviceInterceptor
// AfterReturningAdviceInterceptor is MethodInterceptor
// AfterReturningAdviceInterceptor
//  -> AspectJAfterReturningAdvice
//      -> AbstractAspectJAdvice#invokeAdviceMethodWithGivenArgs
public void afterAnyPublicMethod() {
    System.out.println("@AfterReturning any public method.");
}
```

核心是AbstractAspectJAdvice





## 3.11 Advice 容器接口 - Advisor  

接口 - org.springframework.aop.Advisor
• 通用实现 - org.springframework.aop.support.DefaultPointcutAdvisor  



## 3.12 Pointcut 与 Advice 连接器 -PointcutAdvisor  

接口 - org.springframework.aop.PointcutAdvisor
• 通用实现
		• org.springframework.aop.support.DefaultPointcutAdvisor
• AspectJ 实现
		• org.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor
		• org.springframework.aop.aspectj.AspectJPointcutAdvisor
• 静态方法实现
		• org.springframework.aop.support.StaticMethodMatcherPointcutAdvisor
• IoC 容器实现
		• org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor  



## 3.13 Introduction 与 Advice 连接器  

接口 - org.springframework.aop.IntroductionAdvisor
• 元信息
		• org.springframework.aop.IntroductionInfo
• 通用实现
		• org.springframework.aop.support.DefaultIntroductionAdvisor
• AspectJ 实现
		• org.springframework.aop.aspectj.DeclareParentsAdvisor  



主程序：IntroductionAdvisorDemo



## 3.14 Advisor 的 Interceptor 适配器  

接口 - org.springframework.aop.framework.adapter.**AdvisorAdapter**
• MethodBeforeAdvice 实现
		• org.springframework.aop.framework.adapter.**MethodBeforeAdviceAdapter**
• AfterReturningAdvice 实现
		• org.springframework.aop.framework.adapter.**AfterReturningAdviceAdapter**
• ThrowsAdvice 实现
		• org.springframework.aop.framework.adapter.**ThrowsAdviceAdapter**  





## 3.15 AOP 代理接口 - AopProxy  

接口 - org.springframework.aop.framework.**AopProxy**
实现
		• JDK 动态代理
				• org.springframework.aop.framework.**JdkDynamicAopProxy**
		• CGLIB 字节码提升
				• org.springframework.aop.framework.**CglibAopProxy**
				• org.springframework.aop.framework.ObjenesisCglibAopProxy  



## 3.16 AopProxy 工厂接口与实现  

• 接口 - org.springframework.aop.framework.**AopProxyFactory**

• 默认实现： org.springframework.aop.framework.**DefaultAopProxyFactory**
	• 返回类型
			• org.springframework.aop.framework.JdkDynamicAopProxy
			• org.springframework.aop.framework.CglibAopProxy
					• org.springframework.aop.framework.ObjenesisCglibAopProxy  



## 3.17 JDK AopProxy 实现 - JdkDynamicAopProxy  

实现 - org.springframework.aop.framework.JdkDynamicAopProxy
	• 配置 - org.springframework.aop.framework.AdvisedSupport
	• 来源 - org.springframework.aop.framework.DefaultAopProxyFactory  



1、实现细节AdvisedSupport，JdkDynamicAopProxy类

- **public JdkDynamicAopProxy(AdvisedSupport config)**构造方法，config不可变；config.getAdvisors()为空，即一个Advisior会关联一个advice动作，没有的话就不会形成代理对象。
- **public Object getProxy**(@Nullable ClassLoader classLoader)构造方法：
  
  - AopProxyUtils.completeProxiedInterfaces方法：获取配置中关联的目标类实现的所有的接口（后面将）
  - findDefinedEqualsAndHashCodeMethods():
    - 一般接口中不会重写eq和hc方法
  - Proxy.newProxyInstance()方法
- **public Object invoke()**方法：（难度较大）
  - 参考：[Spring系列之AOP(4)——JdkDynamicAopProxy与CglibAopProxy - 简书 (jianshu.com)](https://www.jianshu.com/p/30dcd2e25868)
  
  - 拦截器、目标方法是一个执行链的关系
  
    

A、补充：

- 子类方法不能缩放继承的父类方法的访问权限，例如父类的eq为public，子类不能声明为protected。



## 3.18 CGLIB AopProxy 实现 - CglibAopProxy  

实现 - org.springframework.aop.framework.CglibAopProxy
	• 配置 - org.springframework.aop.framework.AdvisedSupport
	• 来源 - org.springframework.aop.framework.DefaultAopProxyFactory  

1、CglibAopProxy类

- public Object getProxy(@Nullable ClassLoader classLoader) 
- ntercept方法对应invoke方法



## 3.19 AopProxyFactory 配置管理器  

核心 API - org.springframework.aop.framework.**AdvisedSupport**
• 语义 - 代理配置
• 基类 - org.springframework.aop.framework.ProxyConfig
• 实现接口 - org.springframework.aop.framework.Advised
• 使用场景 - org.springframework.aop.framework.AopProxy 实现  

1、AdvisedSupport

- CglibAopProxy构造器中使用到public CglibAopProxy(AdvisedSupport config)
- 父类：ProxyConfig，AOP代理配置
- AdvisorChainFactory
  - 只有一种实现：DefaultAdvisorChainFactory
- interfaces：目标对象所在的类实现的所有的接口
- advisors：
- advisorArray：和advisors相辅相成，空间换时间
- ProxyFactory extends ProxyCreatorSupport extends AdvisedSupport，所以ProxyFactory#addAdvice()方法。



## 3.20 Advisor 链工厂接口与实现

核心 API - org.springframework.aop.framework.**AdvisorChainFactory**
• 特殊实现 - org.springframework.aop.framework.InterceptorAndDynamicMethodMatcher
• 默认实现 - org.springframework.aop.framework.**DefaultAdvisorChainFactory**  

1、AdvisedSupport中的：

```java
/** The AdvisorChainFactory to use. */
AdvisorChainFactory advisorChainFactory = new DefaultAdvisorChainFactory();
```

2、DefaultAdvisorChainFactory核心方法：getInterceptorsAndDynamicInterceptionAdvice()

- GlobalAdvisorAdapterRegistry.getInstance()
- 返回DefaultAdvisorAdapterRegistry：
  - public DefaultAdvisorAdapterRegistry() {
    		registerAdvisorAdapter(new MethodBeforeAdviceAdapter());
      		registerAdvisorAdapter(new AfterReturningAdviceAdapter());
      		registerAdvisorAdapter(new ThrowsAdviceAdapter());
      	}
  - 这中间就会注册，把advice适配成MethodBeforeAdvice



## 3.21 目标对象来源接口与实现  

核心 API - org.springframework.aop.**TargetSource**
• 实现
• org.springframework.aop.target.HotSwappableTargetSource
• org.springframework.aop.target.AbstractPoolingTargetSource
• org.springframework.aop.target.PrototypeTargetSource
• org.springframework.aop.target.ThreadLocalTargetSource
• org.springframework.aop.target.SingletonTargetSource  



## 3.22 代理对象创建基础类  

核心 API - org.springframework.aop.framework.ProxyCreatorSupport
• 语义 - 代理对象创建基类
• 基类 - org.springframework.aop.framework.AdvisedSupport  

1、ProxyCreatorSupport

- 继承extends AdvisedSupport
- AopProxyFactory aopProxyFactory;



## 3.23 AdvisedSupport 事件监听器  

核心 API - org.springframework.aop.framework.**AdvisedSupportListener**
• 事件对象 - org.springframework.aop.framework.AdvisedSupport
• 事件来源 - org.springframework.aop.framework.**ProxyCreatorSupport**
• 激活事件触发 - ProxyCreatorSupport#createAopProxy
• 变更事件触发 - 代理接口变化时、 Advisor 变化时、 配置复制  

主程序：AdvisedSupportListenerDemo



## 3.24 ProxyCreatorSupport 标准实现  

核心 API - org.springframework.aop.framework.ProxyFactory
• 基类 - org.springframework.aop.framework.**ProxyCreatorSupport**
• 特性增强
		• 提供一些便利操作  































































