# 第三章  Spring AOP API 设计与实现  

## 3.1 Spring AOP API 整体设计  

• Join point - Joinpoint
• Pointcut - Pointcut
• Advice 执行动作 - Advice
• Advice 容器 - Advisor
• Introduction - IntroductionInfo
• 代理对象创建基础类 - ProxyCreatorSupport
• 代理工厂 - ProxyFactory、 ProxyFactoryBean
• AopProxyFactory 配置管理器 - AdvisedSupport
• IoC 容器自动代理抽象 - AbstractAutoProxyCreator  





## 3.2 接入点接口 - Joinpoint  

• Interceptor 执行上下文 - Invocation
		• 方法拦截器执行上下文 - MethodInvocation
		~~• 构造器拦截器执行上下文 - ConstructorInvocation~~
• MethodInvocation 实现
		• 基于反射 - ReflectiveMethodInvocation
		• 基于 CGLIB - CglibMethodInvocation  

（1）

```java
ProxyMethodInvocation extends MethodInvocation
```

（2）

ReflectiveMethodInvocation和CglibMethodInvocation都是实现了ProxyMethodInvocation接口。





## 3.3 Joinpoint 条件接口 - Pointcut  

核心组件
		• 类过滤器 - ClassFilter
		• 方法匹配器 - MethodMatcher  



主程序：EchoServiceEchoMethodPointcut，PointcutAPIDemo



工具类
• ClassFilter 工具类 - ClassFilters
• MethodMatcher 工具类 - MethodMatchers
• Pointcut 工具类 - Pointcuts 

 



## 3.4 Pointcut 便利实现  

• 静态 Pointcut - StaticMethodMatcherPointcut
• 正则表达式 Pointcut - JdkRegexpMethodPointcut
• 控制流 Pointcut - ControlFlowPointcut  



主程序：PointcutAPIDemo

```java
ComposablePointcut pointcut = new ComposablePointcut(EchoServiceEchoMethodPointcut.INSTANCE);
// 组合实现
pointcut.intersection(echoServicePointcut.getClassFilter());
pointcut.intersection(echoServicePointcut.getMethodMatcher());
```





## 3.5 Pointcut AspectJ 实现  

• 实现类 - org.springframework.aop.aspectj.AspectJExpressionPointcut
• 指令支持 - SUPPORTED_PRIMITIVES 字段
• 表达式 - org.aspectj.weaver.tools.PointcutExpression  



Spring利用AspectJ的表达式来桥接

（1）AspectJExpressionPointcut中的pointcutExpression

（2）AspectJExpressionPointcut中的obtainPointcutExpression()方法





## 3.6 Joinpoint 执行动作接口 - Advice  

• **Around Advice** - **Interceptor**
		• 方法拦截器 - **MethodInterceptor**
		• 构造器拦截器 - ConstructorInterceptor
• **前置动作**
		• 标准接口 - org.springframework.aop.BeforeAdvice
		• 方法级别 - org.springframework.aop.MethodBeforeAdvice
• **后置动作**
		• org.springframework.aop.AfterAdvice
		• org.springframework.aop.AfterReturningAdvice
		• org.springframework.aop.ThrowsAdvice  



注意：Advice分为三种，BeforeAdvice,AfterAdvice和Interceptor





## 3.7 Joinpoint Before Advice 标准实现  

• 接口
		• 标准接口 - org.springframework.aop.BeforeAdvice
		• 方法级别 - org.springframework.aop.MethodBeforeAdvice
• 实现
		• org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor  



## 3.8 Joinpoint Before Advice AspectJ 实现  (难度大)

实现类 - org.springframework.aop.aspectj.AspectJMethodBeforeAdvice  



## 3.9 Joinpoint After Advice 标准实现  

**接口**
• org.springframework.aop.AfterAdvice
• org.springframework.aop.AfterReturningAdvice
• org.springframework.aop.ThrowsAdvice
**实现**
• org.springframework.aop.framework.adapter.ThrowsAdviceInterceptor
• org.springframework.aop.framework.adapter.AfterReturningAdviceInterceptor  



1. AfterReturningAdviceInterceptor  

- 三个接口之间的关系

- AfterReturningAdviceInterceptor  

  每个advice都会包装成Interceptor 

- 查看主程序AspectJAnnotationUsingAPIDemo



理解：

AfterReturningAdviceInterceptor中的invoke方法执行的时候：

先调用具体的实现方法Object retVal = mi.proceed();

再调用afterReturning拦截方法。



2.ThrowsAdviceInterceptor

- 从构造函数public ThrowsAdviceInterceptor(Object throwsAdvice)中可以看出方法参数必须是一个或者4个。
- ThrowsAdviceDemo





## 3.10 Joinpoint After Advice AspectJ 实现  

**接口**
• org.springframework.aop.AfterAdvice
• org.springframework.aop.AfterReturningAdvice
• org.springframework.aop.ThrowsAdvice
**实现**
• org.springframework.aop.aspectj.AspectJAfterAdvice
• org.springframework.aop.aspectj.AspectJAfterReturningAdvice
• org.springframework.aop.aspectj.AspectJAfterThrowingAdvice  



- 首先AspectJAfterAdvice，继承了AbstractAspectJAdvice

```java
@AfterReturning("anyPublicMethod()")
// AspectJAfterReturningAdvice is AfterReturningAdvice
// 一个 AfterReturningAdviceInterceptor 关联一个 AfterReturningAdvice
// Spring 封装 AfterReturningAdvice -> AfterReturningAdviceInterceptor
// AfterReturningAdviceInterceptor is MethodInterceptor
// AfterReturningAdviceInterceptor
//  -> AspectJAfterReturningAdvice
//      -> AbstractAspectJAdvice#invokeAdviceMethodWithGivenArgs
public void afterAnyPublicMethod() {
    System.out.println("@AfterReturning any public method.");
}
```

核心是AbstractAspectJAdvice











